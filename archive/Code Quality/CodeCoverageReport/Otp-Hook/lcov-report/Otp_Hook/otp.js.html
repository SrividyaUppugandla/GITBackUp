<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for Otp_Hook/otp.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">Otp_Hook/</a> otp.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">75% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>45/60</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">58.33% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>14/24</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">85.71% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>6/7</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">75% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>45/60</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * Created by 423919 on 5/18/2016.
 * This is the Otp module which generate a token and validate the same
 */
// dependencies for this module
var crypto = require('crypto');
var cipherPwd = 'oyeilyodd';
var encryptionType = 'aes192';
var randomString = require("randomstring");
var bodyParser = require('body-parser');
var jsonParser = bodyParser.json();
var config = require('./config.json');
//constructor
var Otp = function () {
&nbsp;
};
&nbsp;
&nbsp;
// This api is use to generate an OTP based on the length,type and expiry
// time
&nbsp;
Otp.prototype.generateOtp = function (app) {
    // route for generate Otp
    app.post("/generate", jsonParser, function (req, res) {
        var otpOptions = {};
        //creating the otpOptions from the config.json
        otpOptions.length = (config.otp &amp;&amp; config.otp.otpLength) ? config.otp.otpLength : <span class="branch-1 cbranch-no" title="branch not covered" >4;</span>
        otpOptions.charset = (config.otp &amp;&amp; config.otp.otpType) ? config.otp.otpType : <span class="branch-1 cbranch-no" title="branch not covered" >'numeric';</span>
        var expiryTime = (config.otp &amp;&amp; config.otp.otpExpiryTime) ? config.otp.otpExpiryTime : <span class="branch-1 cbranch-no" title="branch not covered" >10;</span>
        var otpCode = randomString.generate(otpOptions);
       
        //otpGenTime will have current time in milliseconds
        var otpGenTime = Date.now();
        //generating the expiry time in milliseconds
        var otpExpiryTime = otpGenTime + (expiryTime * 60000);
        //generating the secret data for the key which is a combination
        // of otpcode and expiry time in the format ("otpCode-otpExpiryTime")
        var secretData = otpCode + '-' + otpExpiryTime;
&nbsp;
        // encrypting the secretData with the cipherPwd
        var cipher = crypto.createCipher(encryptionType, cipherPwd);
        var encrypted = cipher.update(secretData, 'utf8', 'hex');
        encrypted += cipher.final('hex');
&nbsp;
        // checking the channel in config.json 
        <span class="missing-if-branch" title="else path not taken" >E</span>if (config.channel === 'twilio') {
            //hooking the twilio to OTP
            var twilio = require("./twilioservice.js");
            var twilioObj = new twilio();
            //creating the options for twilio
            var msgObj = {
                "accountSID": config.twilio.accountSID,
                "authToken": config.twilio.authToken,
                "to": config.twilio.toRecipient,
                "from": config.twilio.from,
                "body": "OTP pin is " + otpCode
&nbsp;
            };
            
            twilioObj.sendMessage(msgObj, function (err, result) {
                res.header("Access-Control-Allow-Origin", "*");
                res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
                <span class="missing-if-branch" title="else path not taken" >E</span>if (err) {
&nbsp;
                    res.send(JSON.stringify(err), 400);
                }
                else {
<span class="cstat-no" title="statement not covered" >                    var resObj = {</span>
                        otpCode: otpCode,
                        otpKey: encrypted
                    };
&nbsp;
<span class="cstat-no" title="statement not covered" >                    res.send(JSON.stringify(resObj), 200);</span>
                    
                }
&nbsp;
            });
        } else <span class="cstat-no" title="statement not covered" >if (config.channel === 'sendgrid') {</span>
            //hooking the sendgrid to OTP
<span class="cstat-no" title="statement not covered" >            var sendmail = require("./sendgridservice.js");</span>
<span class="cstat-no" title="statement not covered" >            var sendmailObj = new sendmail();</span>
            //creating the options for sendgrid
<span class="cstat-no" title="statement not covered" >            var msgObj = {</span>
                "accountSID": config.sendgrid.accountSID,
                "authToken": config.sendgrid.authToken,
                "toRecipient": config.sendgrid.toRecipient,
                "fromMail": config.sendgrid.from,
                "subject": "Please find the otp",
                "text": "OTP pin is " + otpCode
            };
<span class="cstat-no" title="statement not covered" >            sendmailObj.sendMail(msgObj, <span class="fstat-no" title="function not covered" >function (err, result) {</span></span>
<span class="cstat-no" title="statement not covered" >                res.header("Access-Control-Allow-Origin", "*");</span>
<span class="cstat-no" title="statement not covered" >                res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");</span>
<span class="cstat-no" title="statement not covered" >                if (err) {</span>
<span class="cstat-no" title="statement not covered" >                    res.send(JSON.stringify(err), 400);</span>
                }
                else {
<span class="cstat-no" title="statement not covered" >                    var resObj = {</span>
                        otpCode: otpCode,
                        otpKey: encrypted
                    };
<span class="cstat-no" title="statement not covered" >                    res.send(JSON.stringify(resObj), 200);</span>
                }
            });
        }
    });
};
&nbsp;
// This api is used to validate the otp given by the user,
// with the key
Otp.prototype.validateOtp = function (app) {
&nbsp;
    app.post("/validate", jsonParser, function (req, res) {
&nbsp;
        //creating the Decipher with the cipherPwd
        var decipher = crypto.createDecipher(encryptionType, cipherPwd);
        // gets the otp key 
        var encrypted = req.body.otpKey;
        // decrypting the key to get the OTP and expiry time which comes in "OTP-EXPIRYTIME" format
        var decrypted = decipher.update(encrypted, 'hex', 'utf8');
        decrypted += decipher.final('utf8');
        // spliting the "OTP-EXPIRYTIME" format decrrypt data to get otp and expiry time
        var splitedSecretData = decrypted.split('-');
        var status = {};
        var currentTime = Date.now();
        res.header("Access-Control-Allow-Origin", "*");
        res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
        <span class="missing-if-branch" title="if path not taken" >I</span>if (req.body.otpCode === splitedSecretData[0] &amp;&amp; splitedSecretData[1] &gt; currentTime) {
<span class="cstat-no" title="statement not covered" >            status.status = "OTP is validated successfully";</span>
<span class="cstat-no" title="statement not covered" >            res.send(JSON.stringify(status), 200);</span>
        } else {
            status.status = "OTP validation failed ";
            res.send(JSON.stringify(status), 400);
        }
       
       
&nbsp;
&nbsp;
    });
};
&nbsp;
module.exports = Otp;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Jun 06 2016 10:28:42 GMT+0000 (UTC)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
